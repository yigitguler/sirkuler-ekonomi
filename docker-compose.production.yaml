services:
  web:
    build: .
    command: bash -c "mkdir -p /app/sirkulerekonomi/data && chown -R django:django /app/sirkulerekonomi/staticfiles /app/sirkulerekonomi/media /app/sirkulerekonomi/data 2>/dev/null || true && /app/entrypoint.sh"
    volumes:
      - static_volume:/app/sirkulerekonomi/staticfiles
      - media_volume:/app/sirkulerekonomi/media
      - sqlite_data:/app/sirkulerekonomi/data
    environment:
      PYTHONPATH: /app/sirkulerekonomi
      DJANGO_SETTINGS_MODULE: sirkulerekonomi.settings.production
    user: root

  nginx:
    image: nginx:1.25-alpine
    ports:
      - "80:80"
    volumes:
      - ./conf/nginx_production.conf:/etc/nginx/conf.d/default.conf:ro
      - static_volume:/home/ubuntu/sirkulerekonomi/staticfiles
      - media_volume:/home/ubuntu/sirkulerekonomi/media
    depends_on:
      - web

volumes:
  static_volume:
  media_volume:
  sqlite_data:
